#!/usr/bin/env bash

set -e
[ -n "$VIMENV_DEBUG" ] && set -x

if [ ! -d "$VIMENV_ROOT"/versions ]; then
  mkdir "$VIMENV_ROOT"/versions
fi

VIM_SOURCE="$VIMENV_ROOT"/src
if [ ! -e "$VIM_SOURCE" ]; then
  hg clone https://vim.googlecode.com/hg "$VIM_SOURCE"
fi

#if hg incoming --cwd "$VIM_SOURCE" >/dev/null
#then
#   hg pull --cwd "$VIM_SOURCE" && hg --rebase --dest default --keepbranches --cwd "$VIM_SOURCE"
#fi

if [ -e "$VIMENV_ROOT"/versions/"$VIM_VERSION" ]; then
  rm -rf "$VIMENV_ROOT"/versions/"$VIM_VERSION"
fi

cd "$VIM_SOURCE"

configure() {
    ./configure \
    --with-features=huge \
    --with-compiledby="yasu <adminrooter7@gmail.com>" \
    --enable-multibyte \
    --enable-rubyinterp \
    --enable-python3interp \
    --enable-perlinterp \
    --disable-tclinterp \
    --enable-mzschemeinterp \
    --enable-luainterp \
    --with-lua-prefix=/usr \
    --enable-cscope \
    --enable-fail-if-missing \
    --prefix=$VIMENV_ROOT/versions/vim "$*"
}

clean() {
  if [ -e "$VIM_SOURCE" ]; then
    rm -rf "$VIM_SOURCE"
  fi
}

trap clean EXIT
configure && make -f "$VIM_SOURCE"/Makefile && make install

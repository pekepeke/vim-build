#!/bin/sh

set -e
[ -n "$VIMENV_DEBUG" ] && set -x

if [ ! -d "$VIMENV_ROOT"/versions ]; then
  mkdir "$VIMENV_ROOT"/versions
fi

VIM_SOURCE="$VIMENV_ROOT"/src
if [ ! -e "$VIM_SOURCE" ]; then
  hg clone https://vim.googlecode.com/hg "$VIM_SOURCE"
fi

while getopts v: OPT
do
  case $OPT in
    "o" ) VIM_VERSION="$OPTARG";;
     *  ) exit 1;;
  esac
done

shift `expr $OPTIND - 1`

config_options="$@"

if [ ! -n "$VIM_VERSION" ]; then
  VIM_VERSION="vim"
fi


if [ -e "$VIMENV_ROOT"/versions/"$VIM_VERSION" ]; then
  rm -rf "$VIMENV_ROOT"/versions/"$VIM_VERSION"
fi

cd "$VIM_SOURCE" 

echo "$config_options"
read -p "config enter"
configure() {
   ./configure \
     --with-features=huge \
     --enable-multibyte=yes \
     --enable-rubyinterp=yes \
     --enable-python3interp=yes \
     --enable-perlinterp=yes \
     --disable-tclinterp \
     --enable-mzschemeinterp=yes \
     --enable-luainterp=yes \
     --with-lua-prefix=/usr \
     --enable-cscope \
     --enable-fail-if-missing \
     --prefix=$VIMENV_ROOT/versions/"$VIM_VERSION" "$config_options"
}


clean() {
  if [ -e "$VIM_SOURCE" ]; then
    rm -rf "$VIM_SOURCE"
  fi
}

# trap clean EXIT
configure && make -f "$VIM_SOURCE"/Makefile && make install && clean

#!/usr/bin/env bash

set -e
[ -n "$VIMENV_DEBUG" ] && set -x

if [ ! -d "$VIMENV_ROOT"/versions ]; then
  mkdir "$VIMENV_ROOT"/versions
fi

VIM_SOURCE="$VIMENV_ROOT"/src
if [ ! -e "$VIM_SOURCE" ]; then
  hg clone https://vim.googlecode.com/hg "$VIM_SOURCE"
fi

if [ -e "$VIMENV_ROOT"/versions/"$VIM_VERSION" ]; then
  rm -rf "$VIMENV_ROOT"/versions/"$VIM_VERSION"
fi

cd "$VIM_SOURCE"

configure() {
    ./configure \
    --prefix=$VIMENV_ROOT/versions/vim "$*"
}

clean() {
  if [ -e "$VIM_SOURCE" ]; then
    rm -rf "$VIM_SOURCE"
  fi
}

trap clean EXIT
configure && make -f "$VIM_SOURCE"/Makefile && make install
